# ADR-003: Задание 2. Разработка дизайна модуля пакетной обработки данных
## Автор: Сурков Александр
## Дата: 15.09.2025

## 1. Контекст
Каждое утро ровно в шесть онлайн-магазину нужно сгенерировать кастомные CSV/XLS прайс-листы для B2B-клиентов на основе текущих данных в БД. 
Процесс выгрузки не требует дополнительной логики по обработке данных.
Данные в PostgreSQL представлены в таблицах:
- products ~ 5000–10000 строк;
- categories ~ 50–200 строк;
- clients ~ 100–500 строк;
- client_prices ~ 10000–20000 строк.

Необходимо связать данные из таблиц и выгрузить их в CSV-файл. Объём данных 5 000 –10 000 строк. Инфраструктура магазина — микросервисы в облаке.

## 2. Требования
- Обоснуйте выбор технологического решения
- Составьте диаграмму контекста C4-архитектуры системы To Be. Опишите, как будет работать решение.
- Подготовить верхнеуровневый пошаговый план конфигурации и его имплементации, который выполняют требуемый функционал.

## 3. Решение
### 3.1 Выбор технологического решения
Сравнение подходов к реализации выгрузки прайс-листа:

| Свойство                                                                               | Spring Batch                  | Apache Airflow    | K8s Job                       | Spark                         |
|----------------------------------------------------------------------------------------|-------------------------------|-------------------|-------------------------------|-------------------------------|
| Наличие конфигурации CRON-расписания                                                   | Да, @Scheduled                | Да, настройки DAG | Да, CronJob                   | Нет                           |
| Сложность реализации логики по обработке данных                                        | Просто                        | Просто            | Не делает                     | Просто                        |
| Сложность реализации решения с точки зрения инфраструктуры                             | Просто(есть инфраструктур)    | Сложно            | Средняя                       | Сложно                        |
| Ресурсоемкость решения (количество потребляемых ресурсов)                              | Пропорционально объему данных | Данные х 3        | Пропорционально объему данных | Пропорционально объему данных |
| Масштабируемость решения под нагрузкой и сложность реализации                          | Сложно                        | Хорошая           | Скорее сложно                 | Отличная                      |
| Сложность развертывания в облаке и интеграция с имеющейся микросервисной  архитектурой | Деплой с микросервисом        | Сложно            | Просто                        | Сложно                        |
| Удобство интеграции с системами логирования и мониторинга                              | Просто                        | Встроена          | Средней сложности             | Выше средней сложности        |

Добавил пункт _Сложность реализации решения с точки зрения инфраструктуры_, т.к. написание кода может быть простым, но развернуть его в ПРОМ может быть сложным. Оценка делалась с учетом того, что уже есть микросервисная инфраструктура.

В требованиях не говорится необходимо ли сохранять отчет в виде файла или достаточно отправить его по почте.
Если после формирования прайс-листа его необходимо сохранить и предоставить к нему доступ, то необходимо продумать инфраструктуру для хранения. Для начала подойдет простой файловый сервер, на котором будет сохраняться файл, а ссылка на него будет храниться в БД. Альтернативным вариантом может послужить хранилище S3.

Исходя из сравнительной таблицы наиболее приемлемым решением видится Spring Batch. Этот выбор обосновывается так же следующими критериями:
- небольшой объем исходных и результирующих данных
- простая логика получения прайс-листа
- уже существует микросервисная инфраструктура для развертывания решения

### 3.2 Диаграмму контекста C4-архитектуры
```plantuml
@startuml
!include https://raw.githubusercontent.com/SurkovAleksandr/MSA-AgroTech-sprint-1/refs/heads/master/c4_model/C4_Context.puml
SHOW_PERSON_OUTLINE()

title Диаграмма контекста C4 онлайн-магазина в части реализации выгрузки прайс-листа 

Person_Ext(person, "Потребитель прайс-листа", "Пользователь, который должен получить прайс-лист")
Person(developer, "Разработчик микросервиса", "Разработчик микросервиса")

System(online_store, "Онлайн-магазин", "Интернет-магазин - набор микросервисов.")
System(ci_cd, "Системы CI/CD, мониторинга", "Разворачивание и мониторинг микросервисов")
System(file_store, "Система хранения файлов", "Система хранения файлов.")

Rel(developer, online_store, "Разрабатывает функционал", "Java")
Rel(ci_cd, online_store, "Деплой микросервисов")

Rel_Neighbor(online_store, file_store, "Сохранение прайс-листа")
Rel_D(person, file_store, "Получение прайс-листа")
@enduml
```

Исходя из принятого решения использовать Spring Batch расчет прайс-листа будет осуществляться в одном из микросервисов. 
После создания прайс-листа он будет отправляться на почту получателям. 

### 3.3 Верхнеуровневый план конфигурации и его имплементации
- создать класс с полями для CSV
- создать бины
    - JdbcCursorItemReader - чтение данных из БД(других микросервисов)
    - FlatFileItemWriter - запись данных в файловое хранилище
- создать step, который объеденит шаги чтения и записи
- создать job
- создать бин с аннотацией @Scheduled, который запускает job. Задать необходимое расписание выполнения задания.

## 4. Альтернативы
В случае большого объема данных и/или сложной логики получения данных, а так же зависимости от других потоков альтернативным решением было бы использование Apache Airflow.

## 5. Недостатки, ограничения, риски
- решение не подойдет в случае увеличения объема данных
- надо предусмотреть, как будет сохраняться файл
- необходимо реализовать получение прайс-листа получателем

